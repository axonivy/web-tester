pipeline {
  agent any

  options {
    buildDiscarder(logRotator(numToKeepStr: '30', artifactNumToKeepStr: '20'))
  }

  stages {
    // TODO only when release or master branch
    stage('build') {
      steps {
        script {
          docker.build('maven').inside {
            def targetBranch = "${env.BRANCH_NAME}-${env.BUILD_NUMBER}"
            sh "git checkout -b ${targetBranch}"

            withCredentials([string(credentialsId: 'gpg.password.axonivy', variable: 'GPG_PWD'), file(credentialsId: 'gpg.keystore.axonivy', variable: 'GPG_FILE')]) {
              sh "gpg --batch --import ${env.GPG_FILE}"
              def phase = isReleaseOrMasterBranch() ? 'deploy' : 'verify'
              def args = "-Dmaven.test.skip=true -Dskip.gpg=false -Dgpg.passphrase='${env.GPG_PWD}'";
              //maven cmd: '--batch-mode -Darguments="' + args + '" release:prepare' //release:perform

              sh "touch test.txt"
              sh "git commit -m 'test'"
            }

            sh "git config --global user.name 'ivy-team'"
            sh "git config --global user.email 'info@ivyteam.ch'"
            withEnv(['GIT_SSH_COMMAND=ssh -o StrictHostKeyChecking=no']) {
              sshagent(credentials: ['github-axonivy']) {
                sh "git push -u origin ${targetBranch}"
                //sh "git branch --set-upstream-to origin/${targetBranch}"

                def message = "Release ${env.BRANCH_NAME}"
                withCredentials([file(credentialsId: 'github-ivyteam-token-repo-manager', variable: 'tokenFile')]) {
                  sh "gh auth login --with-token < ${tokenFile}"
                  sh 'gh pr create --title "title" --body "message" --head ' + targetBranch + ' --base ' + env.BRANCH_NAME
                }
              }
            }
          }
        }
        archiveArtifacts '**/target/*.jar'
      }
    }
  }
}

def isReleaseOrMasterBranch() {
  return env.BRANCH_NAME == 'master' || env.BRANCH_NAME.startsWith('release/') 
}
